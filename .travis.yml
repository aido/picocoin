
language: c

compiler:
  - clang
  - gcc

os:
  - linux
  - osx

osx_image: xcode8

sudo: false

env:
  global:
    - BASE_OUTDIR=$TRAVIS_BUILD_DIR/out
    - ENABLE_COVERAGE=no
    - ENABLE_VALGRIND=no
    - secure: "W4D9Wmi+kJbxJuekKXJnhp665L2ljUuq5jrXmRqBwRDIZxbQi/mJqBEVcHEf/3W3l9W67pLd+mvV0cVv9g0AQ/nkUCSj5JCNJrePeovaQmf1QHluTa+bDUABa68X1sx201uj4EmkGJJHtYkv3Cimucut1C4g83eGXajnptKinqyLnUg9ji8aYmv7wm8n12VFeMM7+RyR53MT0nuPpCEw0hRQJQxKzXq/qw/5Wb0vBU1IovNX6bFQNMgTcHEXpppIh7efaAM50v4lj3zd5ZgLDuREmss/HriuJD3KUCWUoVgOkg+QUyW4IAIiI/dWSX9PJYtf1rKhc4ANwjq828NzyhbMJWlOBOBVAZxg+xWmc5+I+mHgmV/YylTMN4+sFnFi9gdDjmF8ImsME2qjDXm1txFknLeNP4CCEHKYCcgsNGPKUtrn2L9Be99HMScBqy7nmCQyhKvTWnYc7j/Je6PjEkXYNT96VNwZ4U8mXktkNPcYkQ43oMbUplITGiA8s50vuWQTLGjFjj+cxgAsz0rOc7+RSVxogY+MkP3+Fc28BKu1ZLLTvAmADWR+xd/179JnL+IAzM5eHUInlIp56DZF7nDoYFyt/yw3VCRUYPNOXVXzY8vCVGI+Hcr+MjmgDu7lhUeTvREaR3iJjEV3QutN79KYKr+CEeRVIoxOBigRVj4="

  matrix:
    - MAKETARGET=distcheck MAKEJOBS=-j3
    - MAKETARGET=check MAKEJOBS=-j1 ENABLE_COVERAGE=yes
    - MAKETARGET=check MAKEJOBS=-j1 ENABLE_VALGRIND=yes

cache:
  apt: true

addons:
  apt:
    packages:
      - libssl-dev
      - libgmp-dev
      - libjansson-dev
      - libevent-dev
      - lcov
      - valgrind
      - libtool
      - libltdl-dev
  coverity_scan:
    project:
      name: "aido/picocoin"
      description: "Build submitted via Travis CI"
    notification_email: aido@users.noreply.github.com
    build_command_prepend: "./autogen.sh; ./configure; make clean"
    build_command: "make $MAKEJOBS check"
    branch_pattern: coverity

before_install:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew update; fi

install:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install jansson; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install libevent; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install argp-standalone; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install openssl; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ] && [ "$ENABLE_COVERAGE" = "yes" ]; then brew install lcov; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ] && [ "$ENABLE_VALGRIND" = "yes" ]; then brew install valgrind; fi
  - if [ "$ENABLE_COVERAGE" = "yes" ]; then gem install coveralls-lcov; fi

before_script:
  - if [ -n "$USE_SHELL" ]; then export CONFIG_SHELL="$USE_SHELL"; fi
  - test -n "$USE_SHELL" && eval '"$USE_SHELL" -c "./autogen.sh"' || ./autogen.sh

script:
  - OUTDIR=$BASE_OUTDIR/$TRAVIS_PULL_REQUEST/$TRAVIS_JOB_NUMBER-$HOST
  - PICOCOIN_CONFIG="--enable-coverage=$ENABLE_COVERAGE --enable-valgrind=$ENABLE_VALGRIND"
  - PICOCOIN_CONFIG_ALL="--prefix=$TRAVIS_BUILD_DIR/depends/$HOST --bindir=$OUTDIR/bin --libdir=$OUTDIR/lib --cache-file=config.cache  "
  - ./configure $PICOCOIN_CONFIG_ALL $PICOCOIN_CONFIG || ( cat config.log && false)
  - make -s $MAKEJOBS || ( echo "Build failure. Verbose build follows." && make V=1 ; false )
  - export LD_LIBRARY_PATH=$TRAVIS_BUILD_DIR/depends/$HOST/lib
  - make $MAKEJOBS $MAKETARGET

after_success:
  - if [ "$ENABLE_COVERAGE" = "yes" ]; then lcov --compat-libtool --directory . --capture --output-file coverage.info && coveralls-lcov coverage.info; fi

